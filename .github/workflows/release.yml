name: release

on:
  release:
    types: [published]
    workflow_dispatch: # allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up QEMU # multiarch
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Filter # monorepo case: build only changed services
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            workspace-svc:
              - 'apps/workspace-svc/**'
            issue-command-svc:
              - 'apps/issue-command-svc/**'
            issue-query-svc:
              - 'apps/issue-query-svc/**'
            notification-svc:
              - 'apps/notification-svc/**'
            search-svc:
              - 'apps/search-svc/**'
            report-svc:
              - 'apps/report-svc/**'
            gateway:
              - 'apps/gateway/**'
      - name: Build and push workspace-svc
        if: steps.filter.outputs.workspace-svc == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          build-args: |
            SERVICE_NAME=workspace-svc
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/workspace-svc:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/workspace-svc:latest
      - name: Build and push issue-command-svc
        if: steps.filter.outputs.issue-command-svc == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          build-args: |
            SERVICE_NAME=issue-command-svc
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/issue-command-svc:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/issue-command-svc:latest
      - name: Build and push issue-query-svc
        if: steps.filter.outputs.issue-query-svc == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          build-args: |
            SERVICE_NAME=issue-query-svc
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/issue-query-svc:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/issue-query-svc:latest
      - name: Build and push notification-svc
        if: steps.filter.outputs.notification-svc == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          build-args: |
            SERVICE_NAME=notification-svc
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/notification-svc:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/notification-svc:latest
      - name: Build and push search-svc
        if: steps.filter.outputs.search-svc == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          build-args: |
            SERVICE_NAME=search-svc
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/search-svc:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/search-svc:latest
      - name: Build and push report-svc
        if: steps.filter.outputs.report-svc == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          build-args: |
            SERVICE_NAME=report-svc
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/report-svc:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/report-svc:latest
      - name: Build and push gateway
        if: steps.filter.outputs.gateway == 'true'
        uses: docker/build-push-action@v4
        with:
          push: true
          context: ./apps/gateway
          file: ./apps/gateway/Dockerfile
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/gateway:${{ github.event.release.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/gateway:latest
            - name: "Run deploy"

      # - name: Inspect Image
      #   run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/app:latest
      # - name: "Testing"
      #   run: echo 'not implemented'
      # - name: "Run deploy"
      #   run: echo 'not implemented'

      #       uses: appleboy/ssh-action@master
      #       with:
      #         host: ${{ secrets.SERVER_HOST }}
      #         username: ${{ secrets.SERVER_USERNAME }}
      #         key: ${{ secrets.SERVER_KEY }}
      #         port: ${{ secrets.SERVER_PORT }}
      #         script: |
      #           sudo docker-compose -f docker-compose.prod-ci.yml -p prod pull
      #           sudo docker-compose -f docker-compose.prod-ci.yml -p prod up -d
      # commands:
      #       - echo "Post-build phase"
      #       - aws deploy push --application-name my-app --s3-location s3://my-bucket/my-app.zip --source .


